# Build stage - needs devDependencies for vite/typescript
FROM oven/bun:1 AS builder
WORKDIR /app

# Copy package files for dependency resolution
COPY package.json bun.lock ./
COPY nexus/package.json ./nexus/
COPY dashboard/package.json ./dashboard/
COPY the-machine/package.json ./the-machine/
COPY logger/package.json ./logger/

# Install ALL dependencies (including dev) for build
RUN bun install --frozen-lockfile

# Copy source code
COPY tsconfig.json ./
COPY logger ./logger/
COPY nexus ./nexus/
COPY dashboard ./dashboard/

# Build dashboard
RUN cd dashboard && bun vite build

# Production stage - smaller image with only runtime deps
FROM oven/bun:1 AS production
WORKDIR /app

# Copy package files (all workspaces needed for bun to resolve, even if not used at runtime)
COPY package.json bun.lock ./
COPY nexus/package.json ./nexus/
COPY dashboard/package.json ./dashboard/
COPY the-machine/package.json ./the-machine/
COPY logger/package.json ./logger/

# Install production dependencies only
# --ignore-scripts skips postinstall scripts that may fail on arm64
RUN bun install --frozen-lockfile --production --ignore-scripts

# Copy source code (only nexus and logger needed at runtime)
COPY logger ./logger/
COPY nexus ./nexus/

# Copy built dashboard from builder stage
COPY --from=builder /app/dashboard/dist ./nexus/public/

# Remove any stale compiled JS
RUN rm -rf /app/nexus/dist

# Install SSH client for ops domain (Tailscale SSH handles auth)
RUN apt-get update && apt-get install -y openssh-client && rm -rf /var/lib/apt/lists/*

# Create db directory
RUN mkdir -p /app/db

ENV PORT=3000
ENV DB_PATH=/app/db
ENV NODE_ENV=production

# Remove .env.example (we use Docker ENV instead)
RUN rm -f /app/nexus/.env.example

# Set ownership to bun user for runtime directories
RUN chown -R bun:bun /app/db /app/nexus

EXPOSE 3000

WORKDIR /app/nexus

# Run as non-root user
USER bun

# Start the server
CMD ["bun", "src/index.ts"]
