FROM oven/bun:1 AS base
WORKDIR /app

# Copy package files for dependency resolution
COPY package.json bun.lock ./
COPY nexus/package.json ./nexus/
COPY dashboard/package.json ./dashboard/
COPY the-machine/package.json ./the-machine/
COPY logger/package.json ./logger/

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source code
COPY tsconfig.json ./
COPY logger ./logger/
COPY nexus ./nexus/
COPY dashboard ./dashboard/

# Remove any stale compiled JS from nexus/dist (we run TypeScript directly with Bun)
RUN rm -rf /app/nexus/dist

# Build dashboard (skip tsc, typecheck runs in CI)
RUN cd dashboard && bun vite build

# Install SSH client for ops domain (Tailscale SSH handles auth)
RUN apt-get update && apt-get install -y openssh-client && rm -rf /var/lib/apt/lists/*

# Create db directory and copy dashboard build to nexus/public
RUN mkdir -p /app/db /app/nexus/public && \
    cp -r /app/dashboard/dist/* /app/nexus/public/

ENV PORT=3000
ENV DB_PATH=/app/db
ENV NODE_ENV=production

# Remove .env.example (we use Docker ENV instead)
RUN rm -f /app/nexus/.env.example

# Set ownership to bun user for runtime directories
RUN chown -R bun:bun /app/db /app/nexus

EXPOSE 3000

WORKDIR /app/nexus

# Run as non-root user
USER bun

# Start the server
CMD ["bun", "src/index.ts"]
