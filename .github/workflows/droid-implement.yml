name: Droid Implement Issue

on:
  issues:
    types: [opened, assigned]
  issue_comment:
    types: [created]

jobs:
  implement:
    if: |
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@droid') || contains(github.event.issue.title, '@droid'))) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request == null && contains(github.event.comment.body, '@droid'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "Droid Agent"
          git config user.email "droidagent@factory.ai"

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create implementation branch
        run: |
          BRANCH="droid/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"

      - name: Post working comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ github.event.issue.number }}" \
            --body "Droid is on it. I'll open a pull request when the implementation is ready."

      - name: Write prompt
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          cat > /tmp/droid-prompt.txt << 'EOF'
          You are implementing a GitHub issue.

          Steps:
          1. Run: gh issue view $ISSUE_NUMBER
             to get the full issue details (title, body, labels, etc.)
          2. Explore the codebase to understand where the changes belong.
          3. Implement the required changes following existing code conventions.
          4. Commit: git add -A && git commit -m "feat: <short description> (closes #$ISSUE_NUMBER)"
          5. Push: git push origin HEAD
          6. Create PR: gh pr create --title "<title>" --body "Closes #$ISSUE_NUMBER" --base main
          EOF

      - name: Implement issue
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          droid exec --auto high -f /tmp/droid-prompt.txt
