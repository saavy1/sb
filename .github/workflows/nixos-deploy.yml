name: NixOS Deploy

on:
  push:
    branches: [main]
    paths:
      - "nixos/**"
  workflow_dispatch:
    inputs:
      force:
        description: "Force rebuild even without changes"
        required: false
        default: "false"

jobs:
  trigger-rebuild:
    name: Trigger NixOS Rebuild
    runs-on: ubuntu-latest
    steps:
      - name: Trigger webhook
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: sha256=$(echo -n '${{ toJson(github.event) }}' | openssl dgst -sha256 -hmac '${{ secrets.NEXUS_WEBHOOK_SECRET }}' | cut -d' ' -f2)" \
            -d '{
              "ref": "${{ github.ref }}",
              "repository": {"full_name": "${{ github.repository }}"},
              "commits": [{"modified": ${{ toJson(github.event.commits[0].modified || '[]') }}, "added": ${{ toJson(github.event.commits[0].added || '[]') }}}],
              "sender": {"login": "${{ github.actor }}"}
            }' \
            https://nexus.superbloom.cloud/webhooks/github
        continue-on-error: true
        # Note: Will fail until Nexus is deployed. That's expected.
