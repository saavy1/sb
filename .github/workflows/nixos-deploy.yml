name: NixOS Deploy

on:
  push:
    branches: [main]
    paths:
      - "nixos/**"
  workflow_dispatch:
    inputs:
      force:
        description: "Force rebuild even without changes"
        required: false
        default: "false"

jobs:
  trigger-rebuild:
    name: Trigger NixOS Rebuild
    runs-on: ubuntu-latest
    steps:
      - name: Trigger webhook
        env:
          WEBHOOK_SECRET: ${{ secrets.NEXUS_WEBHOOK_SECRET }}
        run: |
          BODY='{"trigger":"nixos-rebuild","actor":"${{ github.actor }}"}'
          SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | cut -d' ' -f2)
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$BODY" \
            https://nexus.saavylab.dev/webhooks/github
