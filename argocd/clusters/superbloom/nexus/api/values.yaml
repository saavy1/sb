controllers:
  main:
    serviceAccount:
      name: nexus
    initContainers:
      db-migrate:
        image:
          repository: ghcr.io/saavy1/nexus
          tag: latest
        command:
          - bun
          - run
          - src/migrate.ts
        env:
          DB_PATH: /app/db
        envFrom:
          - secretRef:
              name: nexus-env
    containers:
      main:
        image:
          repository: ghcr.io/saavy1/nexus
          tag: latest
          pullPolicy: Always
        securityContext:
          privileged: true
          runAsUser: 1000
          runAsGroup: 1000
        env:
          NODE_ENV: production
          MODE: api
          PORT: "3000"
          DB_PATH: /app/db
          TS_SOCKET: /var/run/tailscale/tailscaled.sock
          OPS_SSH_HOST: superbloom
          OPS_SSH_USER: saavy
          OPS_FLAKE_PATH: /home/saavy/dev/sb
          OPS_FLAKE_TARGET: superbloom
          OTEL_EXPORTER_OTLP_ENDPOINT: http://grafana-k8s-monitoring-alloy-receiver.alloy:4318
          VALKEY_URL: redis://valkey.valkey.svc.cluster.local:6379
          MC_LOADBALANCER_HOST: minecraft.game-servers.svc.cluster.local
        envFrom:
          - secretRef:
              name: nexus-env
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 3000
              initialDelaySeconds: 10
              periodSeconds: 10
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 3000
              initialDelaySeconds: 5
              periodSeconds: 5
      tailscale:
        image:
          repository: ghcr.io/tailscale/tailscale
          tag: v1.78.1
        env:
          TS_HOSTNAME: nexus
          TS_STATE_DIR: /var/lib/tailscale
          TS_USERSPACE: "true"
          TS_SOCKET: /var/run/tailscale/tailscaled.sock
          TS_KUBE_SECRET: nexus-tailscale
          TS_AUTHKEY:
            valueFrom:
              secretKeyRef:
                name: nexus-env
                key: TS_AUTHKEY
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
service:
  main:
    controller: main
    ports:
      http:
        port: 3000
ingress:
  main:
    enabled: false
persistence:
  db:
    enabled: true
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 1Gi
    storageClass: local-path
    globalMounts:
      - path: /app/db
  dri:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    advancedMounts:
      main:
        main:
          - path: /dev/dri
  tailscale-state:
    enabled: true
    type: emptyDir
    globalMounts:
      - path: /var/lib/tailscale
  tailscale-socket:
    enabled: true
    type: emptyDir
    globalMounts:
      - path: /var/run/tailscale
